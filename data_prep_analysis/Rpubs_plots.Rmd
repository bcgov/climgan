```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(terra)
library(data.table)
library(leaflet)
library(RColorBrewer)
library(ranger)
library(rworldmap)

# load the PRISM  data
prism_jun <- rast("C:/Users/TGRICE/OneDrive - Government of BC/Documents/GANs/PRISM/prec/jun/prism_train_coarse.nc")
prism_jun <- log1p(prism_jun)

# fm4 base
pred_jun_fm4 <- rast("C:/Users/TGRICE/OneDrive - Government of BC/Documents/GANs/Tirion/Results/foundational_model/prec/Model4/jun/jun_fullregion_masked.nc")

# spec1,2,3 of gan50
pred_jun_fm4_spec1 <- rast("C:/Users/TGRICE/OneDrive - Government of BC/Documents/GANs/Tirion/Results/foundational_model/prec/Model4/jun/spec1/gen50/jun_fullregion_masked.nc")
pred_jun_fm4_spec2 <- rast("C:/Users/TGRICE/OneDrive - Government of BC/Documents/GANs/Tirion/Results/foundational_model/prec/Model4/jun/spec2/gen50/jun_fullregion_masked.nc")
pred_jun_fm4_spec3 <- rast("C:/Users/TGRICE/OneDrive - Government of BC/Documents/GANs/Tirion/Results/foundational_model/prec/Model4/jun/spec3/gen50/jun_fullregion_masked.nc")

jun_sd <- app(c(pred_jun_fm4_spec1, pred_jun_fm4_spec2, pred_jun_fm4_spec3), sd)

all_values <- c(values(prism_jun),
                values(pred_jun_fm4),
                values(pred_jun_fm4_spec1),
                values(pred_jun_fm4_spec2),
                values(pred_jun_fm4_spec3)
)

all_values <- all_values[is.finite(all_values)]
inc=diff(range(all_values))/500
breaks=seq(quantile(all_values, 0.00025)-inc, quantile(all_values, 0.99975)+inc, inc)
ColScheme <- colorRampPalette(brewer.pal(9, "YlGnBu"))(length(breaks)-1)
ColPal <- colorBin(ColScheme, bins=breaks, na.color = "white")
ColPal.raster <- colorBin(ColScheme, bins=breaks, na.color = "transparent")

vals <- values(jun_sd)
vals <- vals[!is.na(vals)]
ColScheme_sd <- c("white", "black")
ColPal_sd <- colorNumeric(ColScheme_sd, domain = vals, na.color = "white")
ColPalsd.raster <- colorNumeric(ColScheme_sd, domain = vals, na.color = "transparent")

# leaflet map
map <- leaflet() %>%
  addTiles(group = "basemap") %>%
  addProviderTiles('Esri.WorldImagery', group = "sat photo") %>%
  addRasterImage(prism_jun, colors = ColPal.raster, opacity = 1, maxBytes = 12890669, group = "JUN PRISM") %>%
  addRasterImage(pred_jun_fm4, colors = ColPal.raster, opacity = 1, maxBytes = 12890669, group = "JUN GAN FM4") %>%
  addRasterImage(pred_jun_fm4_spec1, colors = ColPal.raster, opacity = 1, maxBytes = 12890669, group = "JUN GAN50 S1") %>%
  addRasterImage(pred_jun_fm4_spec2, colors = ColPal.raster, opacity = 1, maxBytes = 12890669, group = "JUN GAN50 S2") %>%
  addRasterImage(pred_jun_fm4_spec3, colors = ColPal.raster, opacity = 1, maxBytes = 12890669, group = "JUN GAN50 S3") %>%
  addRasterImage(jun_sd, colors = ColPalsd.raster, opacity = 1, maxBytes = 12890669, group = "JUN GAN50 std dev") %>%
  addLayersControl(
    overlayGroups = c("JUN PRISM",
                      "JUN GAN FM4",
                      "JUN GAN50 S1",
                      "JUN GAN50 S2",
                      "JUN GAN50 S3",
                      "JUN GAN50 std dev"
    ),
    options = layersControlOptions(collapsed = FALSE)
  )
map
```

```{css, echo=FALSE}
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

.leaflet-container {
  height: 100vh !important;
  width: 100vw !important;
}
```

